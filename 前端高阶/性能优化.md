# 前端性能优化

## 减少http请求

比如图片地图，CSS Sprites，内联图片和脚本，样式表的合并。这些技术可以减少响应时间

### 图片地图

就是允许在一个图片上关联多个url，目标url的选择取决于用户单击了图片的哪个位置

超链接带有一些文本，并被关联到目标URL上。可以将超链接关联到图片上，关联多个带有超链接的图片可以减少http请求且无需改变页面外观。就比如一张图片上有5个小图标，按照图标的位置来跳转不同的url

### CSS Sprite

可以合并图片，使用的是css的background-position属性，将html元素通过css放到背景图片上期望的位置上

### 内联图片

通过data:URL模式可以在web页面中包含图片而无需任何额外的http请求，缺点是图片大小可能有限制；URL是内联在页面中的，在跨越页面时不会被缓存。将内联图片放置在外部样式表中增加了一个额外的http请求，但被缓存后可以得到额外的收获

### 合并脚本和样式表

一般来说使用外部脚本和样式对性能更有利，但如果将为了代码可读性将代码分开到多个小文件中，会降低性能，因为每个文件都会导致一个额外的http请求



## 使用内容发布式网络

如果web服务器里用户更近，则一个http请求的响应时间将会缩短。

内容发布式网络是一组分布在多个不同物理位置的web服务器，用于更加有效地向用户发布内容。在优化性能时，向特定用户发布内容的服务器基于对网络可用度的测量，他会选择网络阶跃数量最小的服务器，或者具有最短响应时间的服务器

CDN有助于缓和Web流量峰值压力。但依赖CDN的缺点就是响应时间可能会受到其他网站的流量影响，服务提供商的所有客户之间共享其web服务器组；另一个缺点是无法直接控制组件服务器所带来的特殊麻烦，比如修改http响应头必须通过服务器提供商来完成，如果CDN的性能下降也会有一定的影响



## 添加Expires头

页面的访问者会进行很多的http请求，通过使用一个长久的Expires头，这些组件可以被缓存，这样可以避免不必要的http请求。一般最常用于图片，可以包含不经常变化的组件，包括脚本，样式等。但html文档不应该使用Expires，因为他包含动态内容每次访问时都会刷新

浏览器使用缓存来减少http请求的数量，并减少HTTP请求的大小是web页面加载得更快。Web服务器使用Expires头来告诉Web客户端可以使用一个组件的当前副本直到指定的事件为止

```http
Expires Thu, 15 Apr 2010 20:00:00 GMT
```

使用Cache-Control头来克服Expires头的限制，因为Expires头要求与服务器与客户端的时间严格同步，过期日期需要经常检查。使用max-age指令指定组件被缓存多久



## 压缩组件

通过减小http响应的大小来减少响应时间，如果http请求产生的响应包很小，传输时间就会减少，因为只需将很小的包从服务器传递到客户端。这一效果对速度较慢的带宽尤其明显。

Web客户端可以通过http请求中的Accept-Encoding头来标识对压缩的支持

```http
Accept-Encoding:gzip, deflate
```

如果Web服务器看到请求有这个头，就会使用客户端出来列的方法中的一种来压缩响应，Web服务器通过响应中的Content-Encoding头来通知Web客户端

```http
Content-Encoding:gzip
```

很多网站会压缩html文档，压缩脚本和样式表也可以。

压缩的成本：服务器端会花费额外的CPU周期来完成压缩，客户端要对压缩文件进行压缩。要检测收益是否大于开销，需要考虑响应的大小，连接的带宽和客户端与服务器端之间的Internet距离，根据经验一般对大于1kb或2kb的文件进行压缩



## 将样式表放在顶部

将样式表放在文档底部会导致浏览器中阻止内容逐步呈现。为避免当样式表变化时重绘页面中的元素，浏览器会阻塞内容的逐步呈现。

可以避免白屏，将样式表放在文档顶部的head中，可以使页面逐步呈现。

```html
将样式表包含在文档中的两种方式
<link rel="stylesheet" href="styles1.css">
<style>@import url("styles2.css")</style>
```

一个style块可以包含多个@import规则，但@import规则必须放在其他规则之前。@import可能会导致白屏现象，即使把import规则放在文档的HEAD标签中也是如此。使用@import规则会导致组件下载时的无序性。

样式表在页面中的位置并不影响下载时间，但会影响页面的呈现。若要使浏览器内容逐步呈现则可能需要对已有的图片或文字进行重绘，会造成无样式内容的闪烁。



## 将脚本放在底部

对响应时间影响最大的是页面中组件的数量，当缓存为空时，每个组件都会产生一个HTTP请求

下载脚本时不能并行下载，即使使用了不同的主机名，浏览器也不会启动其他的下载，其中一个原因是为了保证脚本能够按照正确的顺序执行。如果并行下载多个脚本，就无法保证响应是按照特定顺序到达浏览器的。例如后面的脚本比页面之前出现的脚本更小，它可能先执行。如果他们之间存在着依赖关系，不安顺序执行会导致JavaScript错误

**将脚本放在顶部：**会阻塞对其后面内容的呈现；会阻塞对其后面组件的下载

**将脚本放在底部：**不会阻止页面内容的呈现，而且页面中的可视组件可以尽早下载。

将脚本放在顶部时，优先加载脚本，但body中的内容没有加载完，所以有些事件可能无法触发；

如果脚本使用document.write向页面中插入了内容，就不能移动到页面中靠后的位置；DEFER属性表明脚本不包含document.write，浏览器得到这一线索可以继续进行呈现。

## 避免CSS表达式

比如动态页面可以使用css表达式将背景色设置为每小时变化一次

```css
background-color:expression((new Date()).getHours()%2 ? "red" : "blue")
```

对css表达式频繁求值会导致css表达式的低下性能，会影响页面的加载时间

## 使用外部JavaScript和CSS

内联样式相对来说比外部样式快，主要是因为外部示例需要承担多个HTTP请求带来的开销；但是外部文件中的JavaScript和CSS文件有机会被浏览器缓存起来，而包含动态内容的HTML文档通常不会被配置为可以进行缓存。

用户产生的页面查看越少内联样式优势就越高，外部样式的性能提高收益会随用户每月的页面查看次数增长而增长

将页面划分成几种类型，为每种类型创建单独的脚本和样式表

## 减少DNS查找

Internet通过IP地址来查找服务器，由于IP地址很难记忆，通常通过包含主机名的URL来取代它。当浏览器发送请求时，IP地址仍是必须的。DNS将主机域名映射到IP地址上。

如果一个服务器被另一个具有不同IP地址的服务器代替了，DNS允许用户使用同样的主机名来连接到新的服务器，也就是说可以将多个IP地址关联到一个主机名。

DNS也是开销，在DNS查找完成之前，浏览器不能从主机名那里下载到任何东西，响应时间依赖于DNS解析器所承担的压力，距离以及带宽速度。

DNS可以被缓存起来提高性能，但有时间与数量限制

## 精简压缩js

## 避免重定向

重定向用于将用户从一个URL重新路由到另一个URL，常用的有301,302。通常对于html文档进行重定向，可可能在请求页面中的组件时。

当Web服务器向浏览器返回一个重定向时，响应中就会拥有一个范围在3xx的状态码

## 移除重复脚本

重复脚本会产生不必要的http请求和执行JavaScript所浪费的时间。

## 设置ajax可缓存





